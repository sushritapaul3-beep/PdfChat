<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PDF Chat - PDF-GPT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        height: 100vh;
        overflow: hidden;
      }
      .container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 14px 18px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        flex: 0 0 auto;
      }
      .header h1 {
        font-size: 17px;
        font-weight: 700;
      }
      .header p {
        margin-left: auto;
        font-size: 13px;
        opacity: 0.95;
      }
      .main {
        display: flex;
        gap: 20px;
        padding: 20px;
        flex: 1 1 auto;
        min-height: 0;
      }
      .left-panel {
        width: 360px;
        min-width: 240px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 0 0 auto;
      }
      .left-panel h2 {
        font-size: 16px;
        color: #1f2937;
      }
      .left-panel p.sub {
        color: #55606a;
        font-size: 13px;
      }
      .upload-area {
        border: 2px dashed rgba(102, 126, 234, 0.9);
        border-radius: 10px;
        padding: 22px;
        text-align: center;
        background: linear-gradient(180deg, #fff #fff, #fbfbff);
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
        user-select: none;
      }
      .upload-area:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(66, 102, 255, 0.06);
      }
      .upload-area.dragover {
        border-color: #5b3fa7;
        background: #f6f5ff;
      }
      .upload-icon {
        font-size: 40px;
        opacity: 0.9;
        margin-bottom: 8px;
      }
      .upload-area small {
        display: block;
        margin-top: 8px;
        color: #6b7280;
        font-size: 13px;
      }
      .file-info {
        display: none;
        padding: 10px 12px;
        background: #eef6ff;
        border-left: 4px solid rgba(102, 126, 234, 0.9);
        border-radius: 8px;
        color: #1f355a;
        font-size: 13px;
      }
      .chat-panel {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .chat-container {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        flex: 1 1 auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
      }
      .empty-state {
        margin: auto;
        text-align: center;
        color: #5b657a;
      }
      .empty-state .icon {
        font-size: 54px;
        margin-bottom: 10px;
        opacity: 0.85;
      }
      .empty-state h3 {
        font-size: 18px;
        color: #1f2937;
        margin-bottom: 6px;
      }
      .empty-state p {
        color: #55606a;
        font-size: 14px;
      }
      .messages {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 20px;
      }
      .message {
        max-width: 92%;
        display: flex;
        gap: 10px;
        animation: fadeIn 0.14s ease;
      }
      .message.user {
        margin-left: auto;
        justify-content: flex-end;
      }
      .message.assistant {
        margin-right: auto;
        justify-content: flex-start;
      }
      .bubble {
        padding: 12px 16px;
        border-radius: 14px;
        line-height: 1.45;
        font-size: 14px;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
      }
      .message.user .bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border-bottom-right-radius: 6px;
      }
      .message.assistant .bubble {
        background: #fff;
        color: #223;
        border: 1px solid #eef2ff;
        border-bottom-left-radius: 6px;
      }
      .ai-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        margin-left: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .input-section {
        flex: 0 0 auto;
        padding: 12px 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .input-wrapper {
        width: 100%;
        max-width: 1100px;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 0 6px;
      }
      #questionInput {
        flex: 1;
        padding: 12px 14px;
        border-radius: 999px;
        border: none;
        outline: none;
        font-size: 15px;
        box-shadow: 0 10px 30px rgba(9, 30, 66, 0.06);
        background: #fff;
      }
      #questionInput:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      #changeDocBtn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: inline-grid;
        place-items: center;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
        box-shadow: 0 6px 18px rgba(9, 30, 66, 0.06);
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }
      #changeDocBtn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 28px rgba(9, 30, 66, 0.1);
      }
      #changeDocBtn:focus {
        outline: 2px solid rgba(102, 126, 234, 0.22);
      }
      #sendBtn {
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        box-shadow: 0 8px 22px rgba(102, 126, 234, 0.14);
      }
      #sendBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        color: #4455b0;
        font-weight: 700;
      }
      .thinking {
        display: none;
        font-style: italic;
        color: #4455b0;
        padding: 6px 12px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .chat-only .header,
      .chat-only .left-panel,
      .chat-only .file-info {
        display: none !important;
      }
      .chat-only .main {
        padding: 20px;
      }
      #changeDocBtn.hidden {
        display: none;
      }

      @media (max-width: 960px) {
        .main {
          gap: 14px;
          padding: 14px;
          flex-direction: column;
        }
        .left-panel {
          width: 100%;
          min-width: unset;
          order: 1;
        }
        .chat-panel {
          order: 2;
          height: calc(100vh - 260px);
        }
        .chat-container {
          height: calc(100vh - 360px);
        }
      }
      @media (max-width: 520px) {
        .header h1 {
          font-size: 15px;
        }
        .upload-icon {
          font-size: 34px;
        }
        #questionInput {
          font-size: 14px;
        }
        .ai-icon {
          width: 30px;
          height: 30px;
        }
        #changeDocBtn {
          width: 40px;
          height: 40px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container" id="appContainer">
      <div class="header" id="header">
        <h1>ü§ñ PDF Chat</h1>
        <p>Powered by Google Gemini 2.5 Flash</p>
      </div>

      <div class="main" id="mainArea">
        <div class="left-panel" id="leftPanel">
          <div>
            <h2>Upload PDF</h2>
            <p class="sub">Drag & drop or click to upload a PDF (max 10MB)</p>
          </div>

          <div
            class="upload-area"
            id="uploadArea"
            title="Click to upload or drag & drop"
          >
            <div class="upload-icon">üìÅ</div>
            <div><strong>Click to upload</strong></div>
            <small>or drag & drop your PDF here</small>
            <small style="display: block; margin-top: 8px; color: #8b95b2"
              >We will analyze the document and let you chat with it.</small
            >
          </div>

          <input
            type="file"
            id="fileInput"
            accept=".pdf"
            style="display: none"
          />

          <div class="file-info" id="fileInfo"></div>

          <div style="margin-top: auto; font-size: 13px; color: #6b7280">
            Tip: Keep large PDFs under 10MB for faster processing.
          </div>
        </div>

        <div class="chat-panel" id="chatPanel">
          <div class="chat-container" id="chatContainer" aria-live="polite">
            <div class="empty-state" id="initialEmpty">
              <div class="icon">üìÑ</div>
              <h3>Ready to analyze your PDF</h3>
              <p>
                Upload a PDF using the left panel to start chatting with the
                document.
              </p>
            </div>

            <div class="messages" id="messages"></div>
          </div>

          <div class="loading" id="loading">Processing PDF... ‚Ä¢ ‚Ä¢ ‚Ä¢</div>
          <div class="thinking" id="thinking">
            ü§î PDF-GPT is analyzing your question...
          </div>

          <div class="input-section" role="region" aria-label="Chat input">
            <div class="input-wrapper">
              <input
                type="text"
                id="questionInput"
                placeholder="Ask a question about your PDF..."
                disabled
                aria-disabled="true"
              />
              <!-- Change document button (visible in chat-only view) -->
              <button
                id="changeDocBtn"
                class="hidden"
                title="Change document"
                aria-label="Change document"
              >
                <!-- small multi-color AI-style SVG icon -->
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <defs>
                    <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                      <stop offset="0%" stop-color="#4285F4" />
                      <stop offset="50%" stop-color="#34A853" />
                      <stop offset="100%" stop-color="#EA4335" />
                    </linearGradient>
                  </defs>
                  <circle
                    cx="12"
                    cy="12"
                    r="10"
                    fill="url(#g1)"
                    opacity="0.95"
                  />
                  <path
                    d="M7 9c1-1.5 3-3 5-3s4 1.5 5 3"
                    stroke="#fff"
                    stroke-width="1.1"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.95"
                  />
                  <path
                    d="M7 15c1 1.5 3 3 5 3s4-1.5 5-3"
                    stroke="#fff"
                    stroke-width="1.1"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.85"
                  />
                </svg>
              </button>

              <button id="sendBtn" disabled aria-disabled="true">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const apiKey = "<GEMINI API KEY>";
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      const API_ENDPOINT =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const chatContainer = document.getElementById("chatContainer");
      const messagesEl = document.getElementById("messages");
      const questionInput = document.getElementById("questionInput");
      const sendBtn = document.getElementById("sendBtn");
      const loading = document.getElementById("loading");
      const thinking = document.getElementById("thinking");
      const appContainer = document.getElementById("appContainer");
      const initialEmpty = document.getElementById("initialEmpty");
      const header = document.getElementById("header");
      const leftPanel = document.getElementById("leftPanel");
      const changeDocBtn = document.getElementById("changeDocBtn");
      let pdfText = "";
      let pdfFileName = "";
      let conversationHistory = [];
      fileInput.disabled = false;
      uploadArea.classList.remove("disabled");
      changeDocBtn.classList.add("hidden");
      uploadArea.tabIndex = 0;
      uploadArea.addEventListener("keypress", (e) => {
        if (e.key === "Enter" || e.key === " ") fileInput.click();
      });
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () =>
        uploadArea.classList.remove("dragover")
      );
      uploadArea.addEventListener("drop", async (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const f =
          (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) ||
          null;
        if (f && f.type === "application/pdf") {
          await handleFile(f);
        } else {
          showError("Please drop a valid PDF file.");
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });
      function scrollToBottom(smooth = true) {
        setTimeout(() => {
          if (messagesEl.lastElementChild) {
            messagesEl.lastElementChild.scrollIntoView({
              behavior: smooth ? "smooth" : "auto",
              block: "end",
            });
          } else {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }, 40);
      }
      async function handleFile(file) {
        if (file.size > 10 * 1024 * 1024) {
          showError("File size exceeds 10MB limit");
          return;
        }

        pdfFileName = file.name;
        loading.style.display = "block";
        initialEmpty.style.display = "none";
        messagesEl.innerHTML = "";
        conversationHistory = [];
        fileInfo.style.display = "none";

        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

          pdfText = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items
              .map((item) => item.str)
              .join(" ");
            pdfText += `\n--- Page ${i} ---\n${pageText}`;
          }

          fileInfo.innerHTML = `<strong>üìÑ ${pdfFileName}</strong> ‚Äî ${pdf.numPages} pages loaded ¬∑ Ready`;
          fileInfo.style.display = "block";
          questionInput.disabled = false;
          sendBtn.disabled = false;
          questionInput.setAttribute("aria-disabled", "false");
          sendBtn.setAttribute("aria-disabled", "false");
          addAssistantMessage(
            `‚ú® PDF "${pdfFileName}" loaded successfully! I have analyzed ${pdf.numPages} pages of content.\n\nI can:\n‚Ä¢ Summarize sections\n‚Ä¢ Answer specific questions\n‚Ä¢ Extract facts and references\n\nAsk me anything about this document.`
          );
          setTimeout(() => {
            document.body.classList.add("chat-only");
            appContainer.classList.add("chat-only");
            header.style.display = "none";
            leftPanel.style.display = "none";
            fileInfo.style.display = "none";

            changeDocBtn.classList.remove("hidden");
            chatContainer.style.paddingBottom = "22px";
            scrollToBottom(false);
          }, 150);
        } catch (err) {
          console.error(err);
          showError("Error loading PDF: " + (err?.message || "Unknown error"));
        } finally {
          loading.style.display = "none";
          questionInput.focus();
          scrollToBottom(false);
        }
      }
      function createAiIconEl(size = 36) {
        const wrapper = document.createElement("div");
        wrapper.className = "ai-icon";
        wrapper.setAttribute("aria-hidden", "true");
        wrapper.style.width = size + "px";
        wrapper.style.height = size + "px";
        wrapper.innerHTML = `
                <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <defs>
                        <linearGradient id="gA" x1="0" x2="1" y1="0" y2="1">
                            <stop offset="0%" stop-color="#4285F4"/>
                            <stop offset="50%" stop-color="#34A853"/>
                            <stop offset="100%" stop-color="#EA4335"/>
                        </linearGradient>
                    </defs>
                    <circle cx="12" cy="12" r="10" fill="url(#gA)" />
                    <path d="M7 9c1-1.5 3-3 5-3s4 1.5 5 3" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
                    <path d="M7 15c1 1.5 3 3 5 3s4-1.5 5-3" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" opacity="0.85"/>
                </svg>
            `;
        return wrapper;
      }
      function addUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "message user";
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;
        wrapper.appendChild(bubble);
        messagesEl.appendChild(wrapper);
        scrollToBottom();
      }

      function addAssistantMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "message assistant";

        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "10px";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        row.appendChild(createAiIconEl(36));
        row.appendChild(bubble);
        wrapper.appendChild(row);
        messagesEl.appendChild(wrapper);
        scrollToBottom();
      }

      function showError(msg) {
        const err = document.createElement("div");
        err.style.background = "#fff1f0";
        err.style.borderLeft = "4px solid #f44336";
        err.style.padding = "10px 12px";
        err.style.borderRadius = "8px";
        err.style.color = "#611a15";
        err.style.fontSize = "13px";
        err.textContent = "‚ùå " + msg;
        messagesEl.appendChild(err);
        scrollToBottom();
      }
      async function askGemini(question) {
        const prompt = `You are a helpful assistant analyzing the following PDF text.\n\n${pdfText}\n\nUser Question: ${question}\n\nAnswer using ONLY the content from the document. If the information is not present, say so. Be concise and cite pages where appropriate.`;

        const requestBody = {
          contents: [
            {
              parts: [{ text: prompt }],
            },
          ],
        };

        const resp = await fetch(`${API_ENDPOINT}?key=${apiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody),
        });

        if (!resp.ok) {
          let errMsg = "API request failed";
          try {
            const errJson = await resp.json();
            errMsg = errJson.error?.message || errMsg;
          } catch (e) {}
          throw new Error(errMsg);
        }

        const data = await resp.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("Unexpected response format from API");
        return text;
      }
      async function handleQuestion() {
        const question = questionInput.value.trim();
        if (!question) return;

        addUserMessage(question);
        questionInput.value = "";
        questionInput.disabled = true;
        sendBtn.disabled = true;
        thinking.style.display = "block";

        try {
          const answer = await askGemini(question);
          addAssistantMessage(answer);
          conversationHistory.push({ question, answer });
        } catch (err) {
          console.error(err);
          showError(
            `Failed to get response: ${err?.message || "Unknown error"}`
          );
        } finally {
          thinking.style.display = "none";
          questionInput.disabled = false;
          sendBtn.disabled = false;
          questionInput.focus();
        }
      }
      changeDocBtn.addEventListener("click", () => {
        document.body.classList.remove("chat-only");
        appContainer.classList.remove("chat-only");
        header.style.display = "";
        leftPanel.style.display = "";
        fileInfo.style.display = "none";
        changeDocBtn.classList.add("hidden");
        questionInput.disabled = true;
        sendBtn.disabled = true;
        questionInput.setAttribute("aria-disabled", "true");
        sendBtn.setAttribute("aria-disabled", "true");
        setTimeout(() => fileInput.click(), 160);
      });
      sendBtn.addEventListener("click", handleQuestion);
      questionInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !questionInput.disabled) handleQuestion();
      });
      chatContainer.addEventListener("wheel", () => {});
      window.addEventListener("resize", () => {
        chatContainer.style.minHeight = "0";
      });
    </script>
  </body>
</html>

